{% extends 'base.html' %}
{%load static%}
{% block title %}Wishlist{% endblock %}
{% block content %} 
      <!--=============== BREADCRUMB ===============-->
      <section class="breadcrumb">
        <ul class="breadcrumb__list flex container">
          <li><a href="{% url 'home' %}" class="breadcrumb__link">Home</a></li>
          <li><span class="breadcrumb__link"></span>></li>
          <li><span class="breadcrumb__link">Shop</span></li>
          <li><span class="breadcrumb__link"></span>></li>
          <li><span class="breadcrumb__link">Wishlist</span></li>
        </ul>
      </section>

      <!--=============== WISHLIST ===============-->
      {% if user.is_authenticated %}
      <section class="wishlist section--lg container">
        {% if items %}
        <div class="table__container">
          <table class="table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Price</th>
                <th>Stock Status</th>
                <th>Action</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr id="wishlist-item-{{ item.product.id }}">
                <td>
                  {% if item.product.image1 %}
                  <img src="{{ item.product.image1.url }}" alt="" class="table__img" />
                  {% endif %}
                </td>
                <td>
                  <h3 class="table__title">
                    <a href="{% url 'product_details' item.product.id %}">{{ item.product.name }}</a>
                  </h3>
                  <p class="table__description">
                    {{ item.product.description|truncatewords:10 }}
                  </p>
                </td>
                <td>
                  <span class="table__price">
                    â‚¹{% if item.product.offer %}{{ item.product.offer }}{% else %}{{ item.product.price }}{% endif %}
                  </span>
                </td>
                <td>
                  <span class="table__stock">
                    {% if item.product.is_listed %}In Stock{% else %}Out of Stock{% endif %}
                  </span>
                </td>
                <td>
                  <a href="{% url 'product_details' item.product.id %}" class="btn btn--sm">View Product</a>
                </td>
                <td>
                  <i class="fi fi-rs-trash table__trash" 
                     data-product-id="{{ item.product.id }}" 
                     style="cursor: pointer;"
                     title="Remove from wishlist"></i>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="cart__empty-message">
          <h2>Your wishlist is empty!</h2>
          <p>Add some products to your wishlist.</p>
          <a href="{% url 'shop' %}" class="btn btn--md">Continue Shopping</a>
        </div>
        {% endif %}
      </section>
      {% else %}
      <section class="wishlist section--lg container">
        <div class="cart__empty-message">
          <h2>Please login to view your wishlist</h2>
          <a href="{% url 'userlogin' %}" class="btn btn--md">Login</a>
        </div>
      </section>
      {% endif %}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrfToken = getCookie('csrftoken');
axios.defaults.headers.common['X-CSRFToken'] = csrfToken;

// Remove from wishlist
document.querySelectorAll('.table__trash').forEach(function(icon) {
    icon.addEventListener('click', function() {
        const productId = this.dataset.productId;
        
        if (!productId) {
            alert('Product ID not found!');
            return;
        }

        if (!confirm('Are you sure you want to remove this product from your wishlist?')) {
            return;
        }

        axios.post('/wishlist/remove/', {
            product_id: productId
        })
        .then(response => {
            if (response.data.success) {
                // Remove the row from the table
                const row = document.getElementById('wishlist-item-' + productId);
                if (row) {
                    row.remove();
                }
                alert(response.data.message || 'Product removed from wishlist');
                
                // Reload page if no items left
                const remainingItems = document.querySelectorAll('tbody tr').length;
                if (remainingItems === 0) {
                    location.reload();
                }
            } else {
                alert(response.data.message || 'Failed to remove product');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while trying to remove the product.');
        });
    });
});
</script>
{% endblock %}
